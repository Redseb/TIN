<html>
    <head>
        <title>Flappy Bird</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/p5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/addons/p5.dom.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/addons/p5.sound.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="/flappy.css" />

    </head>
    <body>
            <script>
                const SERVER_BASE_URL = "http://localhost:3000"
                //Game variables
                const GAME_SCREEN_HEIGHT = window.innerHeight-window.innerHeight/10;
                const GAME_SCREEN_WIDTH = window.innerWidth;
                let gameState = 0; // -1: gameOver, 0: title, 1: in-game
                let currScore = 0;
                let highscore = 0;
                let username = "";
                //Player variables
                const PLAYER_HEIGHT = GAME_SCREEN_WIDTH/25;
                const PLAYER_WIDTH = GAME_SCREEN_WIDTH/25;
                let player_x = PLAYER_WIDTH;
                let player_y = GAME_SCREEN_HEIGHT/2;
                const PLAYER_JUMP_HEIGHT = GAME_SCREEN_HEIGHT/100*-1;
                let player_velocity = 0;
                const GRAVITY = 0.2;
                const PLAYER_COLOR = [255,255,255];
                //Pipe variables
                const PIPE_HEIGHT = GAME_SCREEN_HEIGHT /3;
                const PIPE_WIDTH = GAME_SCREEN_WIDTH/8;
                const PIPE_SPEED = GAME_SCREEN_WIDTH/300;
                let pipe1_x = GAME_SCREEN_WIDTH;
                let pipe1_y = GAME_SCREEN_HEIGHT/7;
                let pipe2_x = GAME_SCREEN_WIDTH * 1.5;
                let pipe2_y = GAME_SCREEN_HEIGHT/7;
                let pipe3_x = GAME_SCREEN_WIDTH * 3
                let pipe3_y = GAME_SCREEN_HEIGHT/7;
                const MIN_PIPE_GAP = PLAYER_HEIGHT*3;
                const PIPE_COLOR = [255,255,255];
                const PIPE_OUTLINE_COLOR = [150,150,150]
                function setup() {
                    createCanvas(windowWidth,GAME_SCREEN_HEIGHT);
                    background(0);
                    pipe1_y = random(height / 7, 3/4*height)
                    // playButton = createButton("Play!");
                    // playButton.position(width/2, height/2);
                    const playButton = select('#playButton');
                    const usernameInput = select('#usernameInput');
                    username = usernameInput.value();
                    playButton.mousePressed(resetGame);
                }
                function resetGame() {
                    const usernameInput = select('#usernameInput');
                    username = usernameInput.value();
                    player_x = PLAYER_WIDTH;
                    player_y = height/2;
                    currScore = 0;
                    pipe1_x = width;
                    pipe1_y = random(height / 7, 3/4*height);
                    pipe2_x = width * 1.5;
                    pipe2_y = random(height / 7, 3/4*height);
                    pipe3_x = width * 3.5;
                    pipe3_y = random(height / 7, 3/4*height);
                    player_velocity = 0;
                    gameState=1;
                }
                function draw() {  //noprotect
                    background(0);
                    if(gameState == -1){
                        drawGameOverScreen();
                    } else if(gameState == 1){
                        playerGravity();
                        movePipe();
                        drawPlayer();
                        drawPipe();
                        drawScore();
                    } else if(gameState == 0){
                        drawTitleScreen();
                    }
                }
                function drawTitleScreen(){
                    background(0);
                    textSize(height/8);
                    textFont('VT323');
                    fill(255)
                    textAlign(CENTER);
                    text("Retro Bird", width/2, height/8)
                    text("Press Space to FLAP!", width/2, height/2)
                }
                function drawGameOverScreen(){
                    if(currScore > highscore){
                        highscore = currScore;
                    }
                    background(0);
                    textSize(height/8);
                    textFont('VT323');
                    fill(255)
                    textAlign(CENTER);
                    text("Retro Bird", width/2, height/8);
                    text(`Highscore: ${highscore}`, width/2, height/8 * 4);
                    text(`Score: ${currScore}`, width/2, height/8 * 5);
                    if(username.length == 0){
                        text(`Enter a username to upload highscores!`, width/2,height - height/8);
                    }
                    
                }
                function playerGravity(){
                    if(player_y >= height-PLAYER_HEIGHT){
                        player_y = height-PLAYER_HEIGHT;
                        player_velocity=0;
                        gameState = -1;
                    } else if(player_y < 0-PLAYER_HEIGHT){ //stops player from flying too high
                        player_y = 0-PLAYER_HEIGHT;
                        player_velocity=0;
                    } else {
                        player_velocity += GRAVITY;
                        player_y += player_velocity
                    }
                }
                function drawPlayer(){
                    fill(color(PLAYER_COLOR));
                    rect(player_x, player_y, PLAYER_WIDTH, PLAYER_HEIGHT);
                }
                function movePipe(){
                    // if(hasCollidedWithPipe(pipe1_x, 0, pipe1_y)){
                    if(hasCollidedWithPipe(pipe1_x, pipe1_y, pipe1_y+MIN_PIPE_GAP) || hasCollidedWithPipe(pipe2_x, pipe2_y, pipe2_y+MIN_PIPE_GAP) || hasCollidedWithPipe(pipe3_x, pipe3_y, pipe3_y+MIN_PIPE_GAP)){
                            console.log("collided");
                            gameState = -1;
                        }
                        pipe1_x-=PIPE_SPEED;
                        pipe2_x-=PIPE_SPEED;
                        pipe3_x-=PIPE_SPEED;
                        if(pipe1_x < 0 - PIPE_WIDTH){
                            console.log("respawn")
                            pipe1_x = GAME_SCREEN_WIDTH;
                            pipe1_y = random(height / 7, 3/4*height)
                            currScore+=1;
                        }
                        if(pipe2_x < 0 - PIPE_WIDTH){
                            console.log("respawn")
                            pipe2_x = GAME_SCREEN_WIDTH;
                            pipe2_y = random(height / 7, 3/4*height)
                            currScore+=1;
                        }
                        if(pipe3_x < 0 - PIPE_WIDTH){
                            console.log("respawn")
                            pipe3_x = GAME_SCREEN_WIDTH;
                            pipe3_y = random(height / 7, 3/4*height)
                            currScore+=1;
                        }
                }
                function drawPipe(){
                    fill(color(PIPE_COLOR));
                    stroke(color(PIPE_OUTLINE_COLOR));
                    rect(pipe1_x, 0, PIPE_WIDTH, pipe1_y);
                    rect(pipe1_x, pipe1_y+MIN_PIPE_GAP, PIPE_WIDTH, height);
                    rect(pipe2_x, 0, PIPE_WIDTH, pipe2_y);
                    rect(pipe2_x, pipe2_y+MIN_PIPE_GAP, PIPE_WIDTH, height);
                    rect(pipe3_x, 0, PIPE_WIDTH, pipe3_y);
                    rect(pipe3_x, pipe3_y+MIN_PIPE_GAP, PIPE_WIDTH, height);
                }
                function hasCollidedWithPipe(pipeX, topPipeHeight, bottomPipeY){
                    if(player_y < topPipeHeight || player_y > bottomPipeY-PLAYER_HEIGHT){
                        if(player_x > pipeX && player_x < pipeX + PIPE_WIDTH)
                            return true;
                        }
                    return false
                }
                function drawScore(){
                    textSize(height/8);
                    textFont('VT323');
                    fill(255)
                    text(currScore, width/2, height/8)
                }
                function keyPressed() {
                    if(key == ' '){
                        player_velocity += PLAYER_JUMP_HEIGHT;
                        if(gameState == 0 || gameState == -1){
                            resetGame();
                        }
                    }
                }
                </script>
                <div id="bottomContainer">
                    <button id="playButton">Play</button>
                    <h3>Username: </h3>
                    <input type="text" id="usernameInput" />
                    <button id="hsButton">
                        <a href="http://localhost:3000/highscore">
                            Highscores
                        </a>
                    </button>
                </div>
    </body>
</html>